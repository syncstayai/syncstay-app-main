<!DOCTYPE html>
<html lang="fr">

<head>
    <title>SyncStay | Menu</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0b0f;
            --card: #18181b;
            --text: #fff;
            --primary: #FF4757;
            --blue: #3742fa;
            --green: #2ed573;
            --yellow: #f59e0b;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding-bottom: 120px;
            -webkit-tap-highlight-color: transparent;
        }

        .hero {
            padding: 20px;
            background: linear-gradient(to bottom, transparent, var(--bg)), url('https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=800&q=80') center/cover;
            height: 200px;
            display: flex;
            align-items: flex-end;
        }

        .table-badge {
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #333;
            font-weight: bold;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .categories {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            overflow-x: auto;
            background: rgba(11, 11, 15, 0.95);
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 1px solid #333;
        }

        .cat-btn {
            background: var(--card);
            padding: 10px 20px;
            border-radius: 30px;
            border: 1px solid #333;
            color: #888;
            font-weight: bold;
            white-space: nowrap;
            transition: 0.2s;
        }

        .cat-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .menu-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            padding: 20px;
        }

        .card {
            background: var(--card);
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid #27272a;
            display: flex;
            flex-direction: column;
        }

        .card img {
            height: 180px;
            object-fit: cover;
            width: 100%;
        }

        .card-content {
            padding: 15px;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .add-btn {
            background: #333;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* FAB & Modals */
        .fab-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .fab-btn {
            padding: 18px;
            border-radius: 18px;
            font-weight: 800;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        #tracker-btn {
            flex: 1;
            background: var(--card);
            border: 1px solid #333;
            display: none;
        }

        #tracker-btn.active {
            display: flex;
            background: var(--blue);
            border-color: var(--blue);
        }

        #cart-btn {
            flex: 2;
            background: var(--primary);
            justify-content: space-between;
            display: none;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 200;
            display: none;
            align-items: flex-end;
        }

        .modal-overlay.open {
            display: flex;
        }

        .sheet {
            background: #1E1E24;
            width: 100%;
            max-height: 85vh;
            border-radius: 25px 25px 0 0;
            padding: 25px;
            overflow-y: auto;
        }

        /* Options Styling */
        .section-title {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            margin: 20px 0 10px 0;
            font-weight: 800;
            letter-spacing: 1px;
        }

        .option-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #333;
        }

        .extra-price {
            color: var(--green);
            font-size: 12px;
            font-weight: bold;
            background: rgba(46, 213, 115, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
        }

        /* Tracker Styling */
        .status-item {
            background: #2a2a35;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #333;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 10px;
        }

        .order-id {
            font-weight: 900;
            font-size: 16px;
            color: #fff;
            letter-spacing: 0.5px;
        }

        .progress-track {
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--blue);
            width: 5%;
            transition: width 2s ease-in-out;
            border-radius: 3px;
        }

        .status-badge {
            font-size: 11px;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.waiting {
            background: rgba(255, 255, 255, 0.1);
            color: #aaa;
        }

        .status-badge.cooking {
            background: rgba(245, 158, 11, 0.2);
            color: var(--yellow);
        }

        .status-badge.ready {
            background: rgba(46, 213, 115, 0.2);
            color: var(--green);
        }

        .cancel-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 12px;
            float: right;
            cursor: pointer;
        }

        /* Cancelled Item Styles */
        .item-cancelled {
            text-decoration: line-through !important;
            opacity: 0.6;
        }

        .item-cancelled * {
            color: #ef4444 !important;
            text-decoration: line-through !important;
        }

        .cancelled-badge {
            background: #ef4444;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 8px;
            text-transform: uppercase;
        }

        /* Toast */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 16px;
            position: fixed;
            z-index: 2000;
            left: 50%;
            bottom: 100px;
            transform: translateX(-50%);
            font-size: 14px;
            opacity: 0;
            transition: 0.3s;
        }

        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 110px;
        }

        /* Cart Items */
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #333;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        /* Premium Animations */
        @keyframes progressComplete {
            from {
                width: 50%;
            }

            to {
                width: 100%;
            }
        }

        @keyframes fadeOutUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        @keyframes slideInNotification {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes bounce {
            from {
                transform: translateY(0);
            }

            to {
                transform: translateY(-5px);
            }
        }

        .premium-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideInNotification 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 350px;
            font-family: 'Inter', sans-serif;
            border-left: 4px solid #ffd700;
        }

        .premium-notification h4 {
            margin: 0 0 8px 0;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .premium-notification p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .notification-icon {
            animation: bounce 0.5s infinite alternate;
        }

        .window-minimize {
            animation: fadeOutUp 0.5s ease-out forwards;
            pointer-events: none;
        }

        .order-tray {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            display: flex;
            gap: 10px;
        }

        .tray-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }

        .tray-icon:hover {
            transform: scale(1.1);
        }
    </style>
</head>

<body>

    <div id="toast">Ajout√© au panier</div>
    <div class="hero">
        <div>
            <h1>SyncStay</h1>
            <div class="table-badge" onclick="openModal('tableModal')">üìç Table <span
                    id="current-table-display">1</span></div>
        </div>
    </div>

    <div class="categories-wrapper">
        <div class="categories">
            <div class="cat-btn active" onclick="filterMenu('all', this)">üî• Tout</div>
            <div class="cat-btn" onclick="filterMenu('burger', this)">üçî Burgers</div>
            <div class="cat-btn" onclick="filterMenu('taco', this)">üåÆ Tacos</div>
            <div class="cat-btn" onclick="filterMenu('side', this)">üçü Sides</div>
            <div class="cat-btn" onclick="filterMenu('drink', this)">ü•§ Boissons</div>
        </div>
    </div>

    <div class="menu-grid" id="menu"></div>

    <div id="fab-container" class="fab-container">
        <div id="tracker-btn" class="fab-btn" onclick="openModal('trackerModal')">‚è±Ô∏è Suivi</div>
        <div id="cart-btn" class="fab-btn" onclick="openModal('cartModal')">
            <span>Panier (<span id="cart-count">0</span>)</span>
            <span id="cart-total">0 DH</span>
        </div>
    </div>

    <div id="tableModal" class="modal-overlay" onclick="closeModal('tableModal')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h2>Choisir votre Table</h2>
            <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px;">
                <script>for (let i = 1; i <= 12; i++) document.write(`<div style="background:#333; padding:15px; border-radius:10px; text-align:center; font-weight:bold; cursor:pointer;" onclick="setTable(${i})">${i}</div>`)</script>
            </div>
        </div>
    </div>

    <div id="optionsModal" class="modal-overlay" onclick="closeModal('optionsModal')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h2 id="opt-title">Personnaliser</h2>
            <div id="opt-list"></div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button
                    style="flex:1; padding:15px; background:#333; border:none; border-radius:15px; color:white; font-weight:bold;"
                    onclick="addToCart(false)">Ajouter</button>
                <button
                    style="flex:2; padding:15px; background:var(--primary); border:none; border-radius:15px; color:white; font-weight:bold;"
                    onclick="addToCart(true)">üöÄ Commander</button>
            </div>
            <div style="text-align:center; margin-top:15px; color:#888;">Total: <span id="livePrice"
                    style="color:white; font-weight:bold">0</span> DH</div>
        </div>
    </div>

    <div id="cartModal" class="modal-overlay" onclick="closeModal('cartModal')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h2>Votre Panier</h2>
            <div id="cart-list"></div>
            <button
                style="width:100%; padding:15px; background:var(--primary); border:none; border-radius:15px; color:white; font-weight:bold; margin-top:20px;"
                onclick="sendBatchOrder()">Confirmer & Envoyer</button>
        </div>
    </div>

    <div id="trackerModal" class="modal-overlay" onclick="closeModal('trackerModal')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h2>Suivi de Commande</h2>
            <p style="color:#888; font-size:13px; margin-bottom:20px;">Annulation possible pendant 20 secondes.</p>
            <div id="tracker-list"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const products = {
            "burger_cheese": {
                name: "Cheese Burger",
                price: 45,
                cat: "burger",
                img: "https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=600",
                desc: "B≈ìuf, Cheddar, Oignons",
                options: {
                    sauces: ["Biggy", "Alg√©rienne", "Ketchup"],
                    extras: [{ name: "Extra Fromage", price: 5 }, { name: "Double Viande", price: 15 }],
                    removals: ["Oignons", "Cornichons"]
                }
            },
            "burger_chicken": {
                name: "Chicken Burger",
                price: 40,
                cat: "burger",
                img: "https://th.bing.com/th/id/OIP.uKRUzQO7CYf7A9M-xBopbwHaFj?w=600",
                desc: "Poulet Pan√©, Salade",
                options: {
                    sauces: ["Mayo", "Poivre", "Andalouse"],
                    extras: [{ name: "Extra Fromage", price: 5 }],
                    removals: ["Salade", "Tomate"]
                }
            },
            "tacos_poulet": {
                name: "Tacos Poulet",
                price: 35,
                cat: "taco",
                img: "https://th.bing.com/th/id/OIP.iGJje7Zjk7L0SLf9gLgQjAHaF7?w=600",
                desc: "Poulet marin√©, Frites",
                options: {
                    sauces: ["Alg√©rienne", "Samoura√Ø", "Curry"],
                    extras: [{ name: "Gratin√©", price: 10 }, { name: "Supp. Viande", price: 10 }],
                    removals: ["Frites"]
                }
            },
            "tacos_viande": {
                name: "Tacos Viande",
                price: 45,
                cat: "taco",
                img: "https://th.bing.com/th/id/OIP.fQztu6Kj7m5V7AoqYa_CHgHaE8?w=600",
                desc: "Viande Hach√©e",
                options: {
                    sauces: ["Biggy", "Harissa"],
                    extras: [{ name: "Gratin√©", price: 10 }],
                    removals: ["Frites"]
                }
            },
            "frites": {
                name: "Frites",
                price: 15,
                cat: "side",
                img: "https://images.unsplash.com/photo-1630384060421-cb20d0e0649d?w=600",
                desc: "Portion de frites",
                options: {
                    sauces: ["Ketchup", "Mayo"],
                    extras: [{ name: "Cheddar Fondu", price: 10 }]
                }
            },
            "nuggets": {
                name: "Nuggets x6",
                price: 25,
                cat: "side",
                img: "https://th.bing.com/th/id/OIP.l6aRSoyIQa_AGIqa6tC0hwHaE8?w=600",
                desc: "6 pi√®ces",
                options: { sauces: ["Barbecue", "Curry"] }
            },
            "coca_zero": {
                name: "Coca Zero",
                price: 15,
                cat: "drink",
                img: "https://images.unsplash.com/photo-1622483767028-3f66f32aef97?w=600",
                desc: "Canette 33cl",
                options: { removals: ["Gla√ßons", "Citron"] }
            }
        };

        let socket;
        try {
            socket = io();
            console.log('Socket connected');
        } catch (e) {
            console.log("Offline mode");
        }

        const readyAudio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
        readyAudio.volume = 0.7;

        let cart = [], activeOrders = [], currentKey = "", basePrice = 0;
        let tableNum = localStorage.getItem('staySync_table') || "1";

        window.onload = function () {
            document.getElementById("current-table-display").innerText = tableNum;
            renderMenu('all');
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.cat-btn').classList.add('active');
        };

        function renderMenu(cat) {
            const grid = document.getElementById("menu");
            if (!grid) return;

            grid.innerHTML = "";

            for (let key in products) {
                let p = products[key];
                if (cat !== 'all' && p.cat !== cat) continue;

                grid.innerHTML += `
                    <div class="card">
                        <img src="${p.img}" alt="${p.name}">
                        <div class="card-content">
                            <h3>${p.name}</h3>
                            <p>${p.desc}</p>
                            <div class="price-row">
                                <span style="font-weight:bold; font-size:18px;">${p.price} DH</span>
                                <button class="add-btn" onclick="openProduct('${key}')">+</button>
                            </div>
                        </div>
                    </div>`;
            }
        }

        function openProduct(key) {
            currentKey = key;
            const p = products[key];
            basePrice = p.price;

            let html = "";
            if (p.options) {
                if (p.options.sauces) {
                    html += `<div class="section-title">Sauces (Max 2)</div>`;
                    p.options.sauces.forEach(s => {
                        html += `<div class="option-row"><label>${s}</label><input type="checkbox" value="${s}" class="sauce-check"></div>`;
                    });
                }
                if (p.options.extras) {
                    html += `<div class="section-title">Extras</div>`;
                    p.options.extras.forEach(ex => {
                        html += `<div class="option-row"><label>${ex.name} <span class="extra-price">+${ex.price}</span></label><input type="checkbox" value="${ex.name}" data-price="${ex.price}" class="extra-check" onchange="updatePrice()"></div>`;
                    });
                }
                if (p.options.removals) {
                    html += `<div class="section-title">Enlever</div>`;
                    p.options.removals.forEach(r => {
                        html += `<div class="option-row"><label style="color:#ef4444">SANS ${r}</label><input type="checkbox" value="SANS ${r}" class="remove-check"></div>`;
                    });
                }
            }

            document.getElementById("opt-title").innerText = p.name;
            document.getElementById("opt-list").innerHTML = html || "<p style='text-align:center;color:#666;margin-top:20px'>Aucune option</p>";
            updatePrice();
            openModal("optionsModal");
        }

        function updatePrice() {
            let total = basePrice;
            document.querySelectorAll('.extra-check:checked').forEach(c => {
                total += parseInt(c.dataset.price) || 0;
            });
            document.getElementById("livePrice").innerText = total;
        }

        function addToCart(instant = false) {
            const p = products[currentKey];
            let finalPrice = parseInt(document.getElementById("livePrice").innerText);
            let mods = [];

            document.querySelectorAll('.sauce-check:checked').forEach(c => mods.push(c.value));
            document.querySelectorAll('.extra-check:checked').forEach(c => mods.push(c.value));
            document.querySelectorAll('.remove-check:checked').forEach(c => mods.push(c.value));

            cart.push({
                name: p.name,
                price: finalPrice,
                qty: 1,
                mods: mods,
                productKey: currentKey
            });

            if (instant) {
                sendBatchOrder();
            } else {
                updateCartUI();
                showToast("Ajout√© au panier !");
            }
            closeModal("optionsModal");
        }

        function sendBatchOrder() {
            if (cart.length === 0) {
                showToast("Panier vide !");
                return;
            }

            sendOrderToServer(cart);
            cart = [];
            updateCartUI();
            closeModal("cartModal");
        }

        function sendOrderToServer(items) {
            const timestamp = Date.now();
            const orderId = timestamp;
            const shortId = timestamp.toString().slice(-4);

            const orderObj = {
                orderId: orderId,
                shortId: shortId,
                table: tableNum,
                items: JSON.parse(JSON.stringify(items)),
                status: "En attente",
                progress: 5,
                canCancel: true,
                timers: {}
            };

            activeOrders.unshift(orderObj);
            renderTracker();
            updateCartUI();

            if (socket) {
                socket.emit('new_order', orderObj);
                console.log('Order sent to kitchen:', orderId, 'Short ID:', shortId);
            }

            // FIXED: REFINED TIMING LOGIC

            // 1. At 20 seconds: Disable cancellation window
            orderObj.timers.cancelWindow = setTimeout(() => {
                const o = activeOrders.find(x => x.orderId === orderId);
                if (o && o.status === "En attente") {
                    o.canCancel = false;
                    console.log(`Order #${shortId}: Cancellation window closed at 20s`);
                    renderTracker();
                }
            }, 20000);

            // 2. At 30 seconds: Automatically move to cooking state (50%)
            orderObj.timers.cookingStart = setTimeout(() => {
                const o = activeOrders.find(x => x.orderId === orderId);
                if (o && o.status === "En attente") {
                    o.status = "En cuisine";
                    o.progress = 50;
                    o.canCancel = false; // Ensure cancellation is disabled
                    console.log(`Order #${shortId}: Auto-moved to cooking at 30s`);
                    renderTracker();
                }
            }, 30000);
        }

        function cancelOrder(id) {
            const order = activeOrders.find(o => o.orderId === id);
            if (order) {
                // Clear any pending timers
                if (order.timers.cancelWindow) clearTimeout(order.timers.cancelWindow);
                if (order.timers.cookingStart) clearTimeout(order.timers.cookingStart);

                // Mark ALL items as cancelled
                order.items.forEach(item => {
                    item.cancelled = true;
                });

                order.status = "Annul√©";
                order.canCancel = false;
                renderTracker();

                if (socket) {
                    socket.emit("cancel_order", {
                        orderId: id,
                        shortId: order.shortId
                    });
                    console.log('Order canceled:', id);
                }

                // Auto-close: Remove order after short delay
                setTimeout(() => {
                    activeOrders = activeOrders.filter(o => o.orderId !== id);
                    renderTracker();
                    showToast('Commande annul√©e');

                    // Close tracker modal if no more orders
                    if (activeOrders.length === 0) {
                        closeModal('trackerModal');
                    }
                }, 1500);
            }
        }

        function cancelOrderItem(orderId, itemIndex) {
            const order = activeOrders.find(o => o.orderId === orderId);
            if (order && order.items[itemIndex] && !order.items[itemIndex].cancelled) {
                // Mark item as cancelled locally
                order.items[itemIndex].cancelled = true;

                // Send to server
                if (socket) {
                    socket.emit("cancel_item", {
                        orderId: orderId,
                        shortId: order.shortId,
                        itemIndex: itemIndex,
                        itemName: order.items[itemIndex].name
                    });
                    console.log('Item canceled:', orderId, 'Index:', itemIndex);
                }

                // Check if ALL items are now cancelled
                const allCancelled = order.items.every(item => item.cancelled === true);
                if (allCancelled) {
                    // Clear timers
                    if (order.timers.cancelWindow) clearTimeout(order.timers.cancelWindow);
                    if (order.timers.cookingStart) clearTimeout(order.timers.cookingStart);

                    order.status = "Annul√©";
                    order.canCancel = false;

                    // Auto-close: Remove order after short delay
                    setTimeout(() => {
                        activeOrders = activeOrders.filter(o => o.orderId !== orderId);
                        renderTracker();
                        showToast('Commande annul√©e');

                        // Close tracker modal if no more orders
                        if (activeOrders.length === 0) {
                            closeModal('trackerModal');
                        }
                    }, 1500);
                }

                renderTracker();
            }
        }

        // FIXED: Socket event listeners with refined status logic
        if (socket) {
            // Kitchen marks order as ready
            socket.on('status_change', (data) => {
                console.log('Status change received from kitchen:', data);
                const order = activeOrders.find(o => o.orderId === data.orderId);
                if (order && order.status !== "Annul√©") {
                    // Clear any pending timers when kitchen interacts
                    if (order.timers.cancelWindow) clearTimeout(order.timers.cancelWindow);
                    if (order.timers.cookingStart) clearTimeout(order.timers.cookingStart);

                    // Update status and progress based on kitchen action
                    order.status = data.status;

                    if (data.status === 'Pr√™t √† √™tre servi') {
                        order.progress = 100;
                        console.log(`Order #${order.shortId}: Kitchen marked as ready, progress to 100%`);

                        // Play beep sound
                        readyAudio.currentTime = 0;
                        readyAudio.play().catch(e => console.log("Audio error:", e));

                        // Show premium notification
                        showPremiumNotification(order.shortId);

                        // Animate progress bar and minimize tracker after delay
                        setTimeout(() => {
                            // Add minimize animation to tracker modal
                            const trackerSheet = document.querySelector('#trackerModal .sheet');
                            if (trackerSheet) {
                                trackerSheet.classList.add('window-minimize');
                                setTimeout(() => {
                                    trackerSheet.classList.remove('window-minimize');
                                    closeModal('trackerModal');
                                    addToTray(order);
                                }, 500);
                            }
                        }, 2000);

                        // Remove order after 10 seconds
                        setTimeout(() => {
                            activeOrders = activeOrders.filter(o => o.orderId !== data.orderId);
                            renderTracker();
                            removeTrayIcon(order.orderId);
                        }, 10000);
                    }

                    renderTracker();
                }
            });
        }

        function renderTracker() {
            const list = document.getElementById("tracker-list");
            const btn = document.getElementById("tracker-btn");

            if (!list) return;

            list.innerHTML = "";

            if (activeOrders.length > 0) {
                btn.style.display = "flex";
                btn.classList.add("active");
            } else {
                btn.style.display = "none";
                btn.classList.remove("active");
            }

            activeOrders.forEach(order => {
                let badgeClass = "waiting";
                if (order.status === "En cuisine") badgeClass = "cooking";
                if (order.status === "Pr√™t √† √™tre servi") badgeClass = "ready";
                if (order.status === "Annul√©") badgeClass = "waiting";

                let cancelBtn = order.canCancel ?
                    `<button class="cancel-btn" onclick="cancelOrder(${order.orderId})">Annuler</button>` :
                    "";

                let itemsHtml = "";
                if (order.items && Array.isArray(order.items)) {
                    order.items.forEach((item, index) => {
                        // Format all customization details beautifully
                        let customizationHtml = "";
                        if (item.mods && item.mods.length > 0) {
                            // Group mods by type for better display
                            const sauces = item.mods.filter(m =>
                                !m.startsWith("SANS") &&
                                !m.includes("Extra") &&
                                !m.includes("Fromage") &&
                                !m.includes("Viande") &&
                                !m.includes("Gratin√©") &&
                                !m.includes("Cheddar") &&
                                !m.includes("Double") &&
                                !m.includes("Supp.")
                            );

                            const extras = item.mods.filter(m =>
                                m.includes("Extra") ||
                                m.includes("Fromage") ||
                                m.includes("Viande") ||
                                m.includes("Gratin√©") ||
                                m.includes("Cheddar") ||
                                m.includes("Double") ||
                                m.includes("Supp.")
                            );

                            const removals = item.mods.filter(m => m.startsWith("SANS"));

                            // Build HTML for each category
                            if (extras.length > 0) {
                                customizationHtml += `<div style="color: #2ed573; font-size: 11px; margin-top: 2px; line-height: 1.3;">‚ûï ${extras.join(", ")}</div>`;
                            }
                            if (sauces.length > 0) {
                                customizationHtml += `<div style="color: #818cf8; font-size: 11px; margin-top: 2px; line-height: 1.3;">üßÇ ${sauces.join(", ")}</div>`;
                            }
                            if (removals.length > 0) {
                                customizationHtml += `<div style="color: #ef4444; font-size: 11px; margin-top: 2px; line-height: 1.3;">üö´ ${removals.join(", ")}</div>`;
                            }
                        }

                        // Premium trash icon (only visible during cancellation window AND item not cancelled)
                        const itemCancelBtn = (order.canCancel && !item.cancelled) ?
                            `<button style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 5px; margin-left: 10px;" 
                                    onclick="cancelOrderItem(${order.orderId}, ${index})" title="Annuler cet article">
                                <i class="fas fa-trash-alt"></i>
                            </button>` : "";

                        // Check if item is cancelled for styling
                        const cancelledClass = item.cancelled ? "item-cancelled" : "";
                        const cancelledBadge = item.cancelled ? '<span class="cancelled-badge">Annul√©</span>' : "";

                        itemsHtml += `
                            <div class="${cancelledClass}" style="margin-bottom: 12px; padding: 10px; background: ${item.cancelled ? 'rgba(239,68,68,0.1)' : 'rgba(255,255,255,0.03)'}; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; font-size: 14px; line-height: 1.4;">
                                            ${item.qty}x ${item.name} ${cancelledBadge}
                                        </div>
                                        ${customizationHtml}
                                    </div>
                                    ${itemCancelBtn}
                                </div>
                            </div>`;
                    });
                }

                list.innerHTML += `
                    <div class="status-item">
                        <div class="status-header">
                            <span class="order-id">#${order.shortId}</span>
                            <div class="status-badge ${badgeClass}">${order.status}</div>
                        </div>
                        <div style="color:#888; font-size:12px; margin-bottom:10px;">Table ${order.table}</div>
                        <div style="margin-bottom: 15px;">
                            ${itemsHtml}
                        </div>
                        <div class="progress-track">
                            <div class="progress-fill" style="width:${order.progress}%"></div>
                        </div>
                        <div style="overflow:auto; margin-top:10px;">${cancelBtn}</div>
                    </div>`;
            });
        }

        function updateCartUI() {
            document.getElementById("cart-count").innerText = cart.length;
            const total = cart.reduce((sum, item) => sum + item.price, 0);
            document.getElementById("cart-total").innerText = total + " DH";
            document.getElementById("cart-btn").style.display = cart.length > 0 ? "flex" : "none";

            let html = "";
            cart.forEach((item, i) => {
                const modsText = item.mods && item.mods.length > 0 ?
                    `<br><small style="color:#888;">${item.mods.join(", ")}</small>` : "";

                html += `
                    <div class="cart-item">
                        <div>
                            <b>${item.name}</b>
                            ${modsText}
                        </div>
                        <div>
                            ${item.price} DH
                            <button style="background:#333;color:red;border:none;padding:5px 10px;border-radius:5px;margin-left:10px;cursor:pointer;" 
                                    onclick="cart.splice(${i},1);updateCartUI();showToast('Article supprim√©')">
                                X
                            </button>
                        </div>
                    </div>`;
            });

            document.getElementById("cart-list").innerHTML = html || "<p style='text-align:center;color:#666;padding:20px;'>Panier vide</p>";
        }

        function setTable(n) {
            tableNum = n;
            document.getElementById("current-table-display").innerText = n;
            localStorage.setItem('staySync_table', n);
            closeModal("tableModal");
        }

        function showToast(msg) {
            const toast = document.getElementById("toast");
            if (!toast) return;

            toast.innerText = msg;
            toast.classList.add("show");
            setTimeout(() => {
                toast.classList.remove("show");
            }, 2000);
        }

        function openModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.classList.add("open");
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.classList.remove("open");
        }

        function filterMenu(cat, btn) {
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderMenu(cat);
        }

        // Premium notification when order is ready
        function showPremiumNotification(shortId) {
            const notification = document.createElement('div');
            notification.className = 'premium-notification';
            notification.innerHTML = `
                <h4>
                    <span class="notification-icon">‚ú®</span>
                    üéâ Votre commande est pr√™te !
                </h4>
                <p>Notre √©quipe l'apporte √† votre table dans quelques instants.</p>
                <div style="margin-top: 10px; font-size: 12px; opacity: 0.8; display: flex; align-items: center; gap: 5px;">
                    <span>Commande #${shortId}</span>
                    <span>‚Ä¢</span>
                    <span>Bon app√©tit ! üçî</span>
                </div>
            `;

            document.body.appendChild(notification);

            // Auto-remove notification after 5 seconds
            setTimeout(() => {
                notification.style.transition = 'opacity 0.5s, transform 0.5s';
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 5000);
        }

        // Add order to tray when window minimizes
        function addToTray(order) {
            // Create tray if it doesn't exist
            let tray = document.querySelector('.order-tray');
            if (!tray) {
                tray = document.createElement('div');
                tray.className = 'order-tray';
                document.body.appendChild(tray);
            }

            // Check if icon already exists
            if (document.querySelector(`.tray-icon[data-order-id="${order.orderId}"]`)) {
                return;
            }

            // Add tray icon
            const trayIcon = document.createElement('div');
            trayIcon.className = 'tray-icon';
            trayIcon.innerHTML = 'üì¶';
            trayIcon.title = `Commande #${order.shortId} - Pr√™te`;
            trayIcon.setAttribute('data-order-id', order.orderId);

            // Restore tracker when clicked
            trayIcon.addEventListener('click', () => {
                openModal('trackerModal');
                trayIcon.remove();

                // Remove tray if empty
                if (tray.children.length === 0) {
                    tray.remove();
                }
            });

            tray.appendChild(trayIcon);
        }

        // Remove tray icon when order is removed
        function removeTrayIcon(orderId) {
            const trayIcon = document.querySelector(`.tray-icon[data-order-id="${orderId}"]`);
            if (trayIcon) {
                trayIcon.remove();
            }

            // Remove tray if empty
            const tray = document.querySelector('.order-tray');
            if (tray && tray.children.length === 0) {
                tray.remove();
            }
        }
    </script>
</body>

</html>