<!DOCTYPE html>
<html lang="de">

<head>
    <title>Der Gasthof ‚Ä¢ Speisekarte</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg: #050505;
            --surface: #121212;
            --surface-light: #1a1a1a;
            --surface-lighter: #242424;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-tertiary: #6a6a6a;
            --accent-gold: #FFD700;
            --accent-emerald: #10B981;
            --accent-blue: #3B82F6;
            --accent-red: #EF4444;
            --accent-yellow: #F59E0B;
            --glass-bg: rgba(18, 18, 18, 0.85);
            --glass-border: rgba(255, 255, 255, 0.08);
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
            padding-bottom: 100px;
        }

        /* Top Glass Bar */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            z-index: 1000;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-weight: 900;
            font-size: 24px;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, var(--accent-gold), #FFA500);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .top-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .table-pill {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            color: var(--accent-gold);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .waiter-btn,
        .cart-btn {
            background: transparent;
            border: 1px solid var(--accent-emerald);
            color: var(--accent-emerald);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .cart-btn {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .waiter-btn:active,
        .cart-btn:active {
            transform: scale(0.95);
        }

        .waiter-btn.pulsing {
            animation: pulse-green 2s infinite;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
        }

        .cart-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--accent-gold);
            color: #000;
            width: 20px;
            height: 20px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 800;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .cart-badge.show {
            display: flex;
        }

        /* Category Pills */
        .category-bar {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 12px 20px;
            z-index: 999;
            overflow-x: auto;
            white-space: nowrap;
            border-bottom: 1px solid var(--glass-border);
        }

        .category-bar::-webkit-scrollbar {
            display: none;
        }

        .category-pills {
            display: inline-flex;
            gap: 8px;
        }

        .category-pill {
            background: var(--surface-light);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-pill.active {
            background: var(--accent-gold);
            color: #000;
            border-color: var(--accent-gold);
            font-weight: 700;
        }

        /* Product Grid */
        .product-grid {
            padding: 140px 20px 100px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .product-card {
            background: var(--surface);
            border-radius: 24px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--glass-border);
            transition: transform 0.3s, border-color 0.3s;
        }

        .product-card:active {
            transform: scale(0.98);
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: linear-gradient(to bottom, transparent 40%, rgba(0, 0, 0, 0.8) 100%);
        }

        .product-info {
            padding: 20px;
        }

        .product-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .product-desc {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .product-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .product-price {
            font-size: 22px;
            font-weight: 800;
            color: var(--accent-gold);
        }

        .add-button {
            width: 44px;
            height: 44px;
            border-radius: 22px;
            background: var(--accent-gold);
            border: none;
            color: #000;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .add-button:active {
            transform: scale(0.9);
        }

        /* Backdrop Overlay */
        .sheet-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1099;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .sheet-backdrop.active {
            opacity: 1;
            visibility: visible;
        }

        /* Bottom Sheets */
        .bottom-sheet {
            position: fixed;
            bottom: -100%;
            left: 0;
            right: 0;
            background: var(--surface);
            border-radius: 28px 28px 0 0;
            z-index: 1100;
            padding: 24px 20px 40px;
            transition: bottom 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 -20px 60px rgba(0, 0, 0, 0.5);
            max-height: 90vh;
            overflow-y: auto;
            touch-action: pan-y;
        }

        .bottom-sheet.active {
            bottom: 0;
        }

        /* Sheet Header (Scrollable with content) */
        .sheet-header {
            position: relative;
            padding-bottom: 12px;
            margin-bottom: 12px;
        }

        .sheet-close-btn {
            position: absolute;
            top: 12px;
            right: 16px;
            width: 36px;
            height: 36px;
            border-radius: 18px;
            background: var(--surface-lighter);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 20;
        }

        .sheet-close-btn:hover {
            background: var(--surface-light);
            border-color: var(--text-tertiary);
            color: var(--text-primary);
            transform: scale(1.05);
        }

        .sheet-close-btn:active {
            transform: scale(0.95);
        }

        .sheet-title {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        /* Dynamic Island Tracker */
        .dynamic-island {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 50px;
            padding: 12px 24px;
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 999;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            min-width: 200px;
            justify-content: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .dynamic-island.active {
            display: flex;
            animation: slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), glow-pulse 2s infinite;
        }

        .dynamic-island.ready {
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--accent-emerald);
            animation: pulse-ready 2s infinite;
        }

        .dynamic-island.critical {
            background: rgba(239, 68, 68, 0.25);
            border-color: #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
            animation: pulse-red 2s infinite;
            cursor: pointer;
        }

        .tracker-status {
            font-weight: 700;
            font-size: 14px;
            letter-spacing: 0.5px;
        }

        .tracker-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--text-tertiary);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Options Sheet */
        .option-section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .option-item {
            padding: 16px;
            background: var(--surface-light);
            border-radius: 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .option-item.selected {
            background: rgba(255, 215, 0, 0.1);
            border-color: var(--accent-gold);
        }

        .option-name {
            font-weight: 600;
            font-size: 15px;
        }

        .option-price {
            color: var(--accent-emerald);
            font-weight: 700;
            font-size: 14px;
        }

        .option-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 6px;
            border: 2px solid var(--text-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .option-checkbox.selected {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
        }

        .option-checkbox.selected::after {
            content: '‚úì';
            color: #000;
            font-weight: 900;
            font-size: 12px;
        }

        /* Cart Sheet */
        .cart-item {
            padding: 16px;
            background: var(--surface-light);
            border-radius: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-item-info h4 {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .cart-item-mods {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .cart-item-price {
            font-weight: 700;
            color: var(--accent-gold);
            font-size: 16px;
        }

        .cart-remove {
            color: var(--danger);
            background: transparent;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-top: 1px solid var(--glass-border);
            margin-top: 20px;
        }

        .cart-total-text {
            font-size: 18px;
            font-weight: 700;
        }

        .cart-total-amount {
            font-size: 28px;
            font-weight: 900;
            color: var(--accent-gold);
        }

        .confirm-button {
            width: 100%;
            padding: 20px;
            background: var(--accent-gold);
            border: none;
            border-radius: 20px;
            color: #000;
            font-weight: 800;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 20px;
        }

        .confirm-button:active {
            transform: scale(0.98);
        }

        /* Tracker Sheet */
        .order-tracker {
            background: var(--surface-light);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .tracker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .tracker-id {
            font-weight: 900;
            font-size: 18px;
            color: var(--accent-gold);
        }

        .tracker-badge {
            padding: 6px 12px;
            border-radius: 12px;
            font-weight: 800;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-waiting {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
        }

        .badge-cooking {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-yellow);
        }

        .badge-ready {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-emerald);
        }

        .badge-cancelled {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .progress-track {
            height: 6px;
            background: var(--surface-lighter);
            border-radius: 3px;
            overflow: hidden;
            margin: 16px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-gold), var(--accent-emerald));
            width: 5%;
            transition: width 2s ease;
            border-radius: 3px;
        }

        .order-items {
            margin-top: 20px;
        }

        .order-item {
            padding: 12px;
            background: var(--surface-lighter);
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .order-item.cancelled {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .item-name {
            font-weight: 700;
            font-size: 15px;
        }

        .item-price {
            color: var(--accent-gold);
            font-weight: 700;
            font-size: 14px;
        }

        /* New flexbox container for price and cancel button */
        .item-price-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .item-cancel {
            background: rgba(255, 69, 58, 0.2);
            border: 1px solid rgba(255, 69, 58, 0.3);
            color: #FF453A;
            width: 32px;
            height: 32px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .item-cancel:hover {
            background: rgba(255, 69, 58, 0.3);
            border-color: rgba(255, 69, 58, 0.5);
            transform: scale(1.05);
        }

        .item-cancel:active {
            transform: scale(0.9);
        }

        .item-mods {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .tracker-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .action-button {
            flex: 1;
            padding: 16px;
            border-radius: 16px;
            border: none;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .cancel-button {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .close-button {
            background: var(--surface-light);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: var(--surface);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 16px 24px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
            z-index: 1200;
            opacity: 0;
            transition: all 0.3s;
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Animations */
        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }

            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        @keyframes pulse-ready {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(16, 185, 129, 0);
            }

            50% {
                box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes bounce-small {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-3px);
            }
        }

        @keyframes glow-pulse {

            0%,
            100% {
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 0 rgba(255, 215, 0, 0);
            }

            50% {
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.4);
            }
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        /* Responsive */
        @media (min-width: 600px) {
            .product-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>
    <div class="top-bar">
        <div class="logo">SyncStay</div>
        <div class="top-right">
            <div class="table-pill" id="tablePill">
                <i class="fas fa-chair"></i>
                Tisch <span id="currentTable">1</span>
            </div>
            <button class="cart-btn" id="cartBtn" onclick="openCart()">
                <i class="fas fa-shopping-bag"></i>
                <div class="cart-badge" id="cartBadge">0</div>
            </button>
            <button class="waiter-btn" id="waiterBtn" onclick="callWaiter()">
                <i class="fas fa-bell"></i>
            </button>
        </div>
    </div>

    <div class="category-bar">
        <div class="category-pills">
            <div class="category-pill active" onclick="filterMenu('all', this)">üî• Alle</div>
            <div class="category-pill" onclick="filterMenu('burger', this)">üçî Burger</div>
            <div class="category-pill" onclick="filterMenu('classic', this)">üá©üá™ Klassiker</div>
            <div class="category-pill" onclick="filterMenu('beilagen', this)">ü•î Beilagen</div>
            <div class="category-pill" onclick="filterMenu('getranke', this)">üç∫ Getr√§nke</div>
        </div>
    </div>

    <div class="product-grid" id="productGrid"></div>

    <div class="dynamic-island" id="dynamicIsland">
        <div class="tracker-icon">
            <div class="spinner" id="trackerSpinner"></div>
            <i class="fas fa-check" id="trackerCheck" style="display:none;"></i>
        </div>
        <div class="tracker-status" id="trackerStatus">Best√§tigung...</div>
    </div>

    <div class="sheet-backdrop" id="sheetBackdrop" onclick="closeAllSheets()"></div>

    <div class="bottom-sheet" id="optionsSheet">
        <button class="sheet-close-btn" onclick="closeSheet('optionsSheet')" aria-label="Close">
            <i class="fas fa-times"></i>
        </button>
        <div class="sheet-header">
            <h2 class="sheet-title" id="optionsTitle">Anpassen</h2>
        </div>
        <div id="optionsList"></div>
        <div class="cart-total" style="margin-top: 30px; padding-top: 30px;">
            <div class="cart-total-text">Gesamt</div>
            <div class="cart-total-amount" id="livePrice">0 ‚Ç¨</div>
        </div>
        <div style="display:flex; gap:12px; margin-top:20px;">
            <button class="action-button close-button" onclick="closeSheet('optionsSheet')">Abbrechen</button>
            <button class="action-button" style="background:var(--accent-gold);color:#000;"
                onclick="addToCart(false)">Zum Warenkorb hinzuf√ºgen</button>
        </div>
    </div>

    <div class="bottom-sheet" id="cartSheet">
        <button class="sheet-close-btn" onclick="closeSheet('cartSheet')" aria-label="Close">
            <i class="fas fa-times"></i>
        </button>
        <div class="sheet-header">
            <h2 class="sheet-title">Ihr Warenkorb</h2>
        </div>
        <div id="cartList"></div>
        <div class="cart-total">
            <div class="cart-total-text">Gesamt</div>
            <div class="cart-total-amount" id="cartTotal">0 ‚Ç¨</div>
        </div>
        <button class="confirm-button" onclick="sendBatchOrder()">
            Bestellen ‚Ä¢ <span id="cartCount">0</span> Artikel
        </button>
    </div>

    <div class="bottom-sheet" id="trackerSheet">
        <button class="sheet-close-btn" onclick="closeSheet('trackerSheet')" aria-label="Close">
            <i class="fas fa-times"></i>
        </button>
        <div class="sheet-header">
            <h2 class="sheet-title">Bestellungsverfolgung</h2>
        </div>
        <div id="trackerList"></div>
    </div>

    <div class="toast" id="toast"></div>

    <div class="bottom-sheet" id="tableSheet">
        <button class="sheet-close-btn" onclick="closeSheet('tableSheet')" aria-label="Close">
            <i class="fas fa-times"></i>
        </button>
        <div class="sheet-header">
            <h2 class="sheet-title">W√§hlen Sie Ihren Tisch</h2>
        </div>
        <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-top:20px;">
            <script>
                for (let i = 1; i <= 12; i++) {
                    document.write(`<div style="background:var(--surface-light); padding:20px; border-radius:16px; text-align:center; font-weight:700; cursor:pointer; border:2px solid transparent; transition:all 0.2s;" 
                    onclick="setTable(${i})" 
                    onmouseover="this.style.borderColor='var(--accent-gold)'" 
                    onmouseout="this.style.borderColor='transparent'">${i}</div>`);
                }
            </script>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Product data - Premium German Restaurant
        const products = {
            "burger_klassiker": {
                name: "Der Klassiker Burger",
                price: 14.90,
                cat: "burger",
                img: "https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=600&fit=crop",
                desc: "Rindfleisch, Cheddar, Speck, R√∂stzwiebeln",
                options: {
                    sauces: ["Senf", "Ketchup", "Mayonnaise", "Remoulade", "Rahmso√üe"],
                    extras: [{ name: "Extra K√§se", price: 1.50 }, { name: "Doppelt Fleisch", price: 4.00 }],
                    removals: ["Ohne Zwiebeln", "Ohne Speck", "Ohne K√§se"]
                }
            },
            "burger_laugen": {
                name: "Laugen-Burger",
                price: 16.50,
                cat: "burger",
                img: "https://images.unsplash.com/photo-1594212699903-ec8a3eca50f5?w=600&fit=crop",
                desc: "In Laugenbr√∂tchen, Bergk√§se, Ruccola",
                options: {
                    sauces: ["Senf", "Kr√§utermayonnaise", "Rahmso√üe"],
                    extras: [{ name: "Avocado", price: 2.00 }, { name: "Speck", price: 2.50 }],
                    removals: ["Ohne Ruccola", "Ohne Zwiebeln"]
                }
            },
            "burger_bbq": {
                name: "BBQ Bacon Burger",
                price: 17.50,
                cat: "burger",
                img: "https://th.bing.com/th/id/OIP.hT7bKrMCXgilPN1Hpdh-VQHaEJ?w=333&h=187&c=7&r=0&o=7&dpr=1.4&pid=1.7&rm=3",
                desc: "BBQ-Sauce, Cheddar, Speck, Zwiebelringe",
                options: {
                    sauces: ["BBQ-Sauce", "Chipotle", "Knoblauchso√üe"],
                    extras: [{ name: "Extra Speck", price: 2.50 }, { name: "Pulled Pork", price: 4.50 }],
                    removals: ["Ohne Speck", "Ohne Zwiebeln"]
                }
            },
            "classic_currywurst": {
                name: "Berliner Currywurst",
                price: 12.50,
                cat: "classic",
                img: "https://knack-rucksack.fr/wp-content/uploads/2022/10/currywurst-berlin.jpg",
                desc: "Mit Pommes Frites und Curryso√üe",
                options: {
                    sauces: ["Senf", "Ketchup", "Curry", "Scharf"],
                    extras: [{ name: "Extra Pommes", price: 3.00 }, { name: "Bratwurst dazu", price: 5.50 }],
                    removals: ["Ohne Pommes", "Ohne So√üe"]
                }
            },
            "classic_schnitzel": {
                name: "Wiener Schnitzel",
                price: 22.90,
                cat: "classic",
                img: "https://die-frau-am-grill.de/wp-content/uploads/wiener-schnitzel-rezept.jpg",
                desc: "Kalbsschnitzel mit Kartoffelsalat",
                options: {
                    sauces: ["Zitrone", "Preiselbeeren", "Rahmso√üe"],
                    extras: [{ name: "Spiegelei", price: 2.00 }, { name: "Bratkartoffeln statt Salat", price: 0 }],
                    removals: ["Ohne Kartoffelsalat", "Ohne Zitrone"]
                }
            },
            "classic_spaetzle": {
                name: "K√§sesp√§tzle",
                price: 14.50,
                cat: "classic",
                img: "https://images.unsplash.com/photo-1563379926898-05f4575a45d8?w=600&fit=crop",
                desc: "Mit ger√∂steten Zwiebeln und Salat",
                options: {
                    sauces: ["R√∂stzwiebeln extra", "Schnittlauch"],
                    extras: [{ name: "Speckw√ºrfel", price: 2.50 }, { name: "Extra K√§se", price: 2.00 }],
                    removals: ["Ohne Zwiebeln", "Ohne Salat"]
                }
            },
            "beilagen_pommes": {
                name: "Pommes Frites",
                price: 4.50,
                cat: "beilagen",
                img: "https://img.freepik.com/premium-photo/french-fries-photography-restaurant_929907-175.jpg",
                desc: "Knusprige Pommes, rot-wei√ü",
                options: {
                    sauces: ["Ketchup", "Mayonnaise", "Curryso√üe", "Tartarso√üe"],
                    extras: [{ name: "Mit K√§se √ºberbacken", price: 2.00 }]
                }
            },
            "beilagen_bratkartoffeln": {
                name: "Bratkartoffeln",
                price: 5.50,
                cat: "beilagen",
                img: "https://images.unsplash.com/photo-1631452180519-c014fe946bc7?w=600&fit=crop",
                desc: "Mit Speck und Zwiebeln",
                options: {
                    sauces: ["Kr√§uterquark", "Senf"],
                    extras: [{ name: "Spiegelei", price: 2.00 }],
                    removals: ["Ohne Speck", "Ohne Zwiebeln"]
                }
            },
            "beilagen_gurkensalat": {
                name: "Gurkensalat",
                price: 4.00,
                cat: "beilagen",
                img: "https://images.unsplash.com/photo-1540420773420-3366772f4999?w=600&fit=crop",
                desc: "Mit Dill und Sahne",
                options: {
                    removals: ["Ohne Dill", "Ohne Zwiebeln"]
                }
            },
            "getranke_spezi": {
                name: "Paulaner Spezi",
                price: 3.50,
                cat: "getranke",
                img: "https://shop.getraenke-baerlin.de/media/6b/d5/89/1605390458/SPEZI_K_05l_FRONTAL_mit_FLASCHE_150dpi_RGB_2001.jpg",
                desc: "0,33l Glasflasche",
                options: { removals: ["Ohne Eisw√ºrfel", "Ohne Strohhalm"] }
            },
            "getranke_apfelschorle": {
                name: "Apfelschorle",
                price: 3.20,
                cat: "getranke",
                img: "https://thirstytales.com/wp-content/uploads/2024/09/Apple-Cider-Sparkler-Mocktail-Recipe-768x768.jpeg",
                desc: "Apfelsaft mit Sprudelwasser",
                options: { removals: ["Ohne Eisw√ºrfel"] }
            },
            "getranke_helles": {
                name: "Helles Bier",
                price: 4.90,
                cat: "getranke",
                img: "https://www.verywellfit.com/thmb/hsC5kq_hZZBrcSqsRyeh9n3HESw=/2121x1414/filters:fill(FFDB5D,1)/GettyImages-675621379-5be1ebb246e0fb00266d70b0.jpg",
                desc: "0,5l vom Fass",
                options: { removals: ["Ohne Schaum"] }
            },
            "getranke_weizen": {
                name: "Alkoholfreies Weizen",
                price: 4.50,
                cat: "getranke",
                img: "https://img.freepik.com/premium-photo/beer-glass-wooden-table-pub-restaurant_29409-63.jpg",
                desc: "0,5l alkoholfrei",
                options: { removals: ["Ohne Zitrone"] }
            }
        };

        // Socket connection with reconnection logic
        let socket;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        function connectSocket() {
            try {
                socket = io({
                    reconnection: true,
                    reconnectionAttempts: maxReconnectAttempts,
                    reconnectionDelay: 1000,
                    timeout: 20000
                });

                console.log('üîÑ Connecting to server...');

                socket.on('connect', () => {
                    console.log('‚úÖ Socket connected:', socket.id);
                    reconnectAttempts = 0;

                    // Immediately attempt session restoration
                    const savedOrderId = localStorage.getItem('syncstay_active_order');
                    if (savedOrderId) {
                        console.log('üîÑ Attempting to restore session:', savedOrderId);
                        socket.emit('restore_session', savedOrderId);
                    }

                    // Check for pending orders to sync
                    const pendingOrders = JSON.parse(localStorage.getItem('syncstay_pending_orders') || '[]');
                    if (pendingOrders.length > 0) {
                        console.log('üîÑ Syncing pending orders:', pendingOrders.length);
                        pendingOrders.forEach(order => {
                            socket.emit('new_order', order);
                        });
                        localStorage.removeItem('syncstay_pending_orders');
                    }
                });

                socket.on('session_restored', (order) => {
                    console.log('‚úÖ Session restored:', order.shortId);

                    // Clear any existing orders and add the restored one
                    activeOrders = [order];

                    // Update UI immediately
                    renderTracker();
                    updateDynamicIsland();

                    // If order is ready or cancelled, show appropriate state
                    if (order.status === 'Pr√™t √† √™tre servi') {
                        const island = document.getElementById("dynamicIsland");
                        if (island) {
                            island.classList.add("ready");
                            island.classList.remove("critical");
                        }
                    } else if (order.status === 'Annul√©' || order.status === 'Storniert') {
                        const island = document.getElementById("dynamicIsland");
                        if (island) {
                            island.classList.add("critical");
                            island.classList.remove("ready");
                        }
                    }

                    showToast("Session restored successfully!");
                });

                socket.on('session_expired', () => {
                    console.log('‚ö†Ô∏è Session expired');
                    localStorage.removeItem('syncstay_active_order');
                    activeOrders = [];
                    updateDynamicIsland();
                    showToast("Previous session expired");
                });

                socket.on('order_confirmed', (data) => {
                    console.log('‚úÖ Order confirmed by server:', data.shortId);
                    // The order is already in activeOrders from sendOrderToServer
                    // Just ensure UI is updated
                    renderTracker();
                    updateDynamicIsland();
                });

                socket.on('status_change', (data) => {
                    console.log('üìä Status update:', data);
                    const order = activeOrders.find(o => o.orderId === data.orderId);
                    if (order) {
                        order.status = data.status;
                        order.progress = data.progress || 100;

                        if (data.status === 'Pr√™t √† √™tre servi') {
                            readyAudio.currentTime = 0;
                            readyAudio.play().catch(e => console.log("Audio error:", e));

                            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);

                            // Auto-remove after 10 seconds
                            setTimeout(() => {
                                activeOrders = activeOrders.filter(o => o.orderId !== data.orderId);
                                localStorage.removeItem('syncstay_active_order');
                                renderTracker();
                                updateDynamicIsland();
                            }, 10000);
                        }

                        renderTracker();
                        updateDynamicIsland();
                    }
                });

                socket.on('alert_customer', (data) => {
                    console.log('‚ö†Ô∏è Alert from kitchen:', data);

                    const order = activeOrders.find(o => o.orderId === data.orderId);
                    if (order) {
                        if (data.type === 'order') {
                            showToast("‚ö†Ô∏è Ihre Bestellung wurde von der K√ºche storniert");
                            order.status = "Storniert";
                            order.canCancel = false;

                            // Remove from localStorage when cancelled
                            localStorage.removeItem('syncstay_active_order');

                            // Auto-remove after user acknowledges
                            setTimeout(() => {
                                activeOrders = activeOrders.filter(o => o.orderId !== data.orderId);
                                renderTracker();
                                updateDynamicIsland();
                            }, 10000);

                        } else if (data.type === 'item') {
                            showToast(`‚ö†Ô∏è Artikel nicht verf√ºgbar: ${data.itemName}`);
                            if (order.items[data.itemIndex]) {
                                order.items[data.itemIndex].cancelled = true;
                            }
                        }

                        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                        readyAudio.play().catch(e => console.log("Audio warning blocked"));

                        renderTracker();
                        updateDynamicIsland();
                    }
                });

                socket.on('status_update', (data) => {
                    const order = activeOrders.find(o => o.orderId === data.orderId);
                    if (order && data.hasOwnProperty('canCancel')) {
                        order.canCancel = data.canCancel;
                        renderTracker();
                    }
                });

                socket.on('disconnect', () => {
                    console.log('üîå Socket disconnected');
                    showToast("Connection lost - reconnecting...");
                });

                socket.on('connect_error', (error) => {
                    console.log('‚ùå Connection error:', error);
                    reconnectAttempts++;
                    if (reconnectAttempts >= maxReconnectAttempts) {
                        showToast("Offline mode - reconnecting when possible");
                    }
                });

            } catch (e) {
                console.log("‚ùå Socket connection failed:", e);
            }
        }

        // Initialize connection
        connectSocket();

        const readyAudio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
        readyAudio.volume = 0.7;

        let cart = [], activeOrders = [], currentKey = "", basePrice = 0;
        let tableNum = localStorage.getItem('staySync_table') || "1";

        // Initialize
        window.onload = function () {
            document.getElementById("currentTable").innerText = tableNum;
            renderMenu('all');
            updateCartUI();

            // Set active category
            document.querySelectorAll('.category-pill').forEach(b => b.classList.remove('active'));
            document.querySelector('.category-pill').classList.add('active');
        };

        // Heartbeat to keep connection alive
        setInterval(() => {
            if (socket && socket.connected) {
                socket.emit('ping');
            }
        }, 30000);


        // Table selection
        document.getElementById('tablePill').addEventListener('click', () => {
            openSheet('tableSheet');
        });

        function setTable(n) {
            tableNum = n;
            document.getElementById("currentTable").innerText = n;
            localStorage.setItem('staySync_table', n);
            closeSheet('tableSheet');
            showToast(`Tisch ${n} ausgew√§hlt`);
        }

        // Menu rendering
        function renderMenu(cat) {
            const grid = document.getElementById("productGrid");
            if (!grid) return;

            grid.innerHTML = "";

            for (let key in products) {
                let p = products[key];
                if (cat !== 'all' && p.cat !== cat) continue;

                grid.innerHTML += `
                    <div class="product-card" onclick="openProduct('${key}')">
                        <img src="${p.img}" alt="${p.name}" class="product-image">
                        <div class="image-overlay"></div>
                        <div class="product-info">
                            <h3 class="product-title">${p.name}</h3>
                            <p class="product-desc">${p.desc}</p>
                            <div class="product-footer">
                                <div class="product-price">${p.price.toFixed(2)} ‚Ç¨</div>
                                <button class="add-button" onclick="event.stopPropagation(); openProduct('${key}')">+</button>
                            </div>
                        </div>
                    </div>`;
            }
        }

        function filterMenu(cat, btn) {
            document.querySelectorAll('.category-pill').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderMenu(cat);
        }

        // Product options
        function openProduct(key) {
            // Reset state first to clear any previous selections
            resetProductState();

            currentKey = key;
            const p = products[key];
            basePrice = p.price;

            document.getElementById("optionsTitle").innerText = p.name;

            let html = "";
            if (p.options) {
                if (p.options.sauces) {
                    html += `<div class="option-section">
                        <div class="section-title">So√üen (Max 2)</div>`;
                    p.options.sauces.forEach(s => {
                        html += `<div class="option-item" onclick="toggleOption(this, '${s}', 0, 'sauce')">
                            <div class="option-name">${s}</div>
                            <div class="option-checkbox"></div>
                        </div>`;
                    });
                    html += `</div>`;
                }
                if (p.options.extras) {
                    html += `<div class="option-section">
                        <div class="section-title">Extras</div>`;
                    p.options.extras.forEach(ex => {
                        html += `<div class="option-item" onclick="toggleOption(this, '${ex.name}', ${ex.price}, 'extra')">
                            <div class="option-name">${ex.name}</div>
                            <div style="display:flex; align-items:center; gap:12px;">
                                <div class="option-price">+${ex.price.toFixed(2)} ‚Ç¨</div>
                                <div class="option-checkbox"></div>
                            </div>
                        </div>`;
                    });
                    html += `</div>`;
                }
                if (p.options.removals) {
                    html += `<div class="option-section">
                        <div class="section-title">Weglassen</div>`;
                    p.options.removals.forEach(r => {
                        html += `<div class="option-item" onclick="toggleOption(this, '${r}', 0, 'removal')">
                            <div class="option-name" style="color:var(--danger)">${r}</div>
                            <div class="option-checkbox"></div>
                        </div>`;
                    });
                    html += `</div>`;
                }
            }

            document.getElementById("optionsList").innerHTML = html || "<p style='text-align:center;color:var(--text-tertiary);margin-top:20px'>Keine Optionen verf√ºgbar</p>";
            updatePrice();
            openSheet("optionsSheet");
        }

        let selectedOptions = [];
        let extraPrices = 0;

        // Reset product state to clear sticky selections
        function resetProductState() {
            // Clear selection arrays and prices
            selectedOptions = [];
            extraPrices = 0;

            // Reset visual state of all checkboxes
            const optionsSheet = document.getElementById('optionsSheet');
            if (optionsSheet) {
                optionsSheet.querySelectorAll('.option-checkbox').forEach(checkbox => {
                    checkbox.classList.remove('selected');
                });
                optionsSheet.querySelectorAll('.option-item').forEach(item => {
                    item.classList.remove('selected');
                });
            }

            // Reset price display to base price (will be updated by updatePrice)
            if (typeof basePrice === 'number') {
                updatePrice();
            }
        }

        function toggleOption(element, name, price = 0, type = '') {
            const checkbox = element.querySelector('.option-checkbox');
            const isSelected = checkbox.classList.contains('selected');

            if (isSelected) {
                checkbox.classList.remove('selected');
                element.classList.remove('selected');
                selectedOptions = selectedOptions.filter(opt => opt !== name);
                if (price > 0) extraPrices -= price;
            } else {
                // Check for max sauces only if type is 'sauce'
                if (type === 'sauce') {
                    const sauceCount = selectedOptions.filter((opt, idx) => {
                        // Count only sauces by checking all selected items
                        const optionElements = document.querySelectorAll('.option-item.selected');
                        let count = 0;
                        optionElements.forEach(el => {
                            const onclick = el.getAttribute('onclick');
                            if (onclick && onclick.includes("'sauce'")) {
                                count++;
                            }
                        });
                        return false; // Not used, we use count below
                    });

                    // Count actual selected sauces
                    let actualSauceCount = 0;
                    document.querySelectorAll('.option-item.selected').forEach(el => {
                        const onclick = el.getAttribute('onclick');
                        if (onclick && onclick.includes("'sauce'")) {
                            actualSauceCount++;
                        }
                    });

                    if (actualSauceCount >= 2) {
                        showToast("Maximal 2 So√üen erlaubt");
                        return;
                    }
                }

                checkbox.classList.add('selected');
                element.classList.add('selected');
                selectedOptions.push(name);
                if (price > 0) extraPrices += price;
            }

            updatePrice();
        }

        function updatePrice() {
            let total = basePrice + extraPrices;
            document.getElementById("livePrice").innerText = total.toFixed(2) + " ‚Ç¨";
        }

        // Cart functions
        function addToCart(instant = false) {
            const p = products[currentKey];
            let finalPrice = basePrice + extraPrices;

            cart.push({
                name: p.name,
                price: finalPrice,
                qty: 1,
                mods: [...selectedOptions],
                productKey: currentKey
            });

            // Reset
            selectedOptions = [];
            extraPrices = 0;

            if (instant) {
                sendBatchOrder();
            } else {
                updateCartUI();
                showToast("Zum Warenkorb hinzugef√ºgt!");
            }
            closeSheet("optionsSheet");
        }

        function updateCartUI() {
            const count = cart.length;
            const total = cart.reduce((sum, item) => sum + item.price, 0);

            document.getElementById("cartCount").innerText = count;
            document.getElementById("cartTotal").innerText = total.toFixed(2) + " ‚Ç¨";

            // Update cart badge in top bar
            const badge = document.getElementById("cartBadge");
            if (badge) {
                badge.innerText = count;
                if (count > 0) {
                    badge.classList.add("show");
                } else {
                    badge.classList.remove("show");
                }
            }

            // Update cart list
            let html = "";
            cart.forEach((item, i) => {
                const modsText = item.mods && item.mods.length > 0 ?
                    `<div class="cart-item-mods">${item.mods.join(", ")}</div>` : '';

                html += `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <h4>${item.name}</h4>
                            ${modsText}
                            <div class="cart-item-price">${item.price.toFixed(2)} ‚Ç¨</div>
                        </div>
                        <button class="cart-remove" onclick="removeFromCart(${i})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>`;
            });

            document.getElementById("cartList").innerHTML = html ||
                '<div style="text-align:center;padding:40px;color:var(--text-tertiary)">Ihr Warenkorb ist leer</div>';
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartUI();
            showToast("Artikel entfernt");
        }

        function openCart() {
            updateCartUI();
            openSheet("cartSheet");
        }

        // Order functions
        function sendBatchOrder() {
            if (cart.length === 0) {
                showToast("Warenkorb ist leer!");
                return;
            }

            sendOrderToServer(cart);
            cart = [];
            updateCartUI();
            closeSheet("cartSheet");
        }

        function sendOrderToServer(items) {
            const timestamp = Date.now();
            const orderId = timestamp;
            const shortId = timestamp.toString().slice(-4);

            const orderObj = {
                orderId: orderId,
                shortId: shortId,
                table: tableNum,
                tableNumber: tableNum,
                items: JSON.parse(JSON.stringify(items)),
                status: "In Warteschlange",
                progress: 5,
                canCancel: true,
                createdAt: timestamp
            };

            // Save to localStorage IMMEDIATELY for persistence
            localStorage.setItem('syncstay_active_order', orderObj.orderId);
            console.log('üíæ Saved order to localStorage:', orderId);

            activeOrders.unshift(orderObj);
            renderTracker();
            updateDynamicIsland();

            if (socket && socket.connected) {
                socket.emit('new_order', orderObj);
                console.log('üì§ Order sent to server:', shortId);
            } else {
                console.log('‚ö†Ô∏è Offline - order saved locally');
                showToast("Offline - order will sync when connected");
                // Store locally for when connection resumes
                const pendingOrders = JSON.parse(localStorage.getItem('syncstay_pending_orders') || '[]');
                pendingOrders.push(orderObj);
                localStorage.setItem('syncstay_pending_orders', JSON.stringify(pendingOrders));
            }
        }


        // Order cancellation
        function cancelOrder(id) {
            const order = activeOrders.find(o => o.orderId === id);
            if (order && order.canCancel) {
                if (confirm("M√∂chten Sie diese Bestellung wirklich stornieren?")) {
                    order.status = "Storniert";
                    order.canCancel = false;
                    order.items.forEach(item => {
                        item.cancelled = true;
                    });

                    // Remove from localStorage
                    localStorage.removeItem('syncstay_active_order');

                    renderTracker();
                    updateDynamicIsland();

                    if (socket && socket.connected) {
                        socket.emit("cancel_order", {
                            orderId: id,
                            shortId: order.shortId
                        });
                        console.log('Order canceled:', id);
                    }

                    // Auto-remove after 5 seconds
                    setTimeout(() => {
                        activeOrders = activeOrders.filter(o => o.orderId !== id);
                        renderTracker();
                        updateDynamicIsland();
                    }, 5000);
                }
            } else {
                showToast("Stornierung nicht mehr m√∂glich");
            }
        }


        function cancelOrderItem(orderId, itemIndex) {
            const order = activeOrders.find(o => o.orderId === orderId);
            if (order && order.items[itemIndex] && !order.items[itemIndex].cancelled) {
                order.items[itemIndex].cancelled = true;

                if (socket) {
                    socket.emit("cancel_item", {
                        orderId: orderId,
                        shortId: order.shortId,
                        itemIndex: itemIndex,
                        itemName: order.items[itemIndex].name
                    });
                    console.log('Item canceled:', orderId, 'Index:', itemIndex);
                }

                const allCancelled = order.items.every(item => item.cancelled === true);
                if (allCancelled) {
                    if (order.timers.cancelWindow) clearTimeout(order.timers.cancelWindow);
                    if (order.timers.cookingStart) clearTimeout(order.timers.cookingStart);

                    order.status = "Storniert";
                    order.canCancel = false;

                    setTimeout(() => {
                        activeOrders = activeOrders.filter(o => o.orderId !== orderId);
                        renderTracker();
                        updateDynamicIsland();
                    }, 5000);
                }

                renderTracker();
            }
        }

        // Tracker rendering
        function renderTracker() {
            const list = document.getElementById("trackerList");
            if (!list) return;

            list.innerHTML = "";

            if (activeOrders.length === 0) {
                list.innerHTML = `
                    <div style="text-align:center; padding:40px; color:var(--text-tertiary)">
                        <i class="fas fa-clock" style="font-size:40px; margin-bottom:16px; opacity:0.5;"></i>
                        <h3 style="margin-bottom:8px;">Keine aktiven Bestellungen</h3>
                        <p>Ihre Bestellungen erscheinen hier</p>
                    </div>`;
                return;
            }

            activeOrders.forEach(order => {
                let badgeClass = "badge-waiting";
                let badgeText = order.status;

                if (order.status === "In Zubereitung") {
                    badgeClass = "badge-cooking";
                    badgeText = "In Zubereitung";
                } else if (order.status === "Pr√™t √† √™tre servi") {
                    badgeClass = "badge-ready";
                    badgeText = "Bereit zum Servieren";
                } else if (order.status === "Storniert") {
                    badgeClass = "badge-cancelled";
                    badgeText = "Storniert";
                }

                let itemsHtml = "";
                if (order.items && Array.isArray(order.items)) {
                    order.items.forEach((item, index) => {
                        const cancelled = item.cancelled ? "cancelled" : "";
                        const cancelBtn = order.canCancel && !item.cancelled ?
                            `<button class="item-cancel" onclick="cancelOrderItem(${order.orderId}, ${index})">
                                <i class="fas fa-times"></i>
                            </button>` : "";

                        const modsHtml = item.mods && item.mods.length > 0 ?
                            `<div class="item-mods">${item.mods.join(", ")}</div>` : "";

                        itemsHtml += `
                            <div class="order-item ${cancelled}">
                                <div class="item-header">
                                    <div class="item-name">${item.name}</div>
                                    <div class="item-price-row">
                                        <div class="item-price">${item.price.toFixed(2)} ‚Ç¨</div>
                                        ${cancelBtn}
                                    </div>
                                </div>
                                ${modsHtml}
                            </div>`;
                    });
                }

                list.innerHTML += `
                    <div class="order-tracker">
                        <div class="tracker-header">
                            <div class="tracker-id">#${order.shortId}</div>
                            <div class="tracker-badge ${badgeClass}">${badgeText}</div>
                        </div>
                        <div style="color:var(--text-secondary); font-size:14px; margin-bottom:12px;">
                            Tisch ${order.table}
                        </div>
                        <div class="progress-track">
                            <div class="progress-fill" style="width:${order.progress}%"></div>
                        </div>
                        <div class="order-items">
                            ${itemsHtml}
                        </div>
                        ${order.canCancel ? `
                            <div class="tracker-actions">
                                <button class="action-button cancel-button" onclick="cancelOrder(${order.orderId})">
                                    Bestellung stornieren
                                </button>
                            </div>` : ''}
                    </div>`;
            });
        }

        // Dynamic Island
        function updateDynamicIsland() {
            const island = document.getElementById("dynamicIsland");
            const status = document.getElementById("trackerStatus");
            const spinner = document.getElementById("trackerSpinner");
            const check = document.getElementById("trackerCheck");

            if (activeOrders.length === 0) {
                island.classList.remove("active");
                return;
            }

            island.classList.add("active");
            const latestOrder = activeOrders[0];

            if (latestOrder.status === "Pr√™t √† √™tre servi") {
                island.classList.add("ready");
                status.innerHTML = `<div style="display:flex; flex-direction:column; align-items:flex-start; line-height:1.2;">
                    <span style="font-size:14px; font-weight:700;">Bestellung fertig!</span>
                    <span style="font-size:10px; font-weight:400; opacity:0.6;">Tippen zum Ansehen</span>
                </div>`;
                spinner.style.display = "none";
                check.style.display = "block";
                check.className = "fas fa-check";
            } else if (latestOrder.status === "In Zubereitung") {
                island.classList.remove("ready");
                status.innerHTML = `<div style="display:flex; flex-direction:column; align-items:flex-start; line-height:1.2;">
                    <span style="font-size:14px; font-weight:700;">In Zubereitung</span>
                    <span style="font-size:10px; font-weight:400; opacity:0.6;">Tippen zum Ansehen</span>
                </div>`;
                spinner.style.display = "block";
                check.style.display = "none";
            } else if (latestOrder.status === "Storniert") {
                island.classList.add("critical");
                island.classList.remove("ready");
                status.innerHTML = `<div style="display:flex; flex-direction:column; align-items:flex-start; line-height:1.2;">
                    <span style="font-size:14px; font-weight:700;">‚ö†Ô∏è Bestellung storniert</span>
                    <span style="font-size:10px; font-weight:400; opacity:0.6;">Tippen zum Ansehen</span>
                </div>`;
                spinner.style.display = "none";
                check.style.display = "block";
                check.className = "fas fa-exclamation-circle";
            } else {
                island.classList.remove("ready");
                status.innerHTML = `<div style="display:flex; flex-direction:column; align-items:flex-start; line-height:1.2;">
                    <span style="font-size:14px; font-weight:700;">Best√§tigung...</span>
                    <span style="font-size:10px; font-weight:400; opacity:0.6;">Tippen zum Ansehen</span>
                </div>`;
                spinner.style.display = "block";
                check.style.display = "none";
            }
        }

        // Socket events
        if (socket) {
            socket.on('status_change', (data) => {
                const order = activeOrders.find(o => o.orderId === data.orderId);
                if (order && order.status !== "Storniert") {
                    if (order.timers.cancelWindow) clearTimeout(order.timers.cancelWindow);
                    if (order.timers.cookingStart) clearTimeout(order.timers.cookingStart);

                    order.status = data.status;
                    order.progress = 100;

                    readyAudio.currentTime = 0;
                    readyAudio.play().catch(e => console.log("Audio error:", e));

                    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);

                    renderTracker();
                    updateDynamicIsland();

                    setTimeout(() => {
                        activeOrders = activeOrders.filter(o => o.orderId !== data.orderId);
                        renderTracker();
                        updateDynamicIsland();
                    }, 10000);
                }
            });
        }

        // Waiter call
        function callWaiter() {
            const tableNum = document.getElementById("currentTable").innerText;
            const currentOrder = activeOrders[0];
            const savedOrderId = localStorage.getItem('syncstay_active_order');

            const orderId = currentOrder ? currentOrder.orderId : savedOrderId;

            if (!socket || !socket.connected) {
                showToast("‚ö†Ô∏è Verbindung fehlt - Kellner kann nicht gerufen werden");
                return;
            }

            const payload = {
                orderId: orderId,
                tableNumber: tableNum,
                table: tableNum
            };

            socket.emit('call_waiter', payload);
            showToast("üîî Kellner gerufen - Tisch " + tableNum);

            // Visual feedback
            const btn = document.getElementById("waiterBtn");
            btn.classList.add("pulsing");
            btn.innerHTML = '<i class="fas fa-check"></i>';

            setTimeout(() => {
                btn.classList.remove("pulsing");
                btn.innerHTML = '<i class="fas fa-bell"></i>';
            }, 30000);
        }


        // UI Helpers
        function openSheet(id) {
            // Close any other open sheets first
            document.querySelectorAll('.bottom-sheet').forEach(sheet => {
                sheet.classList.remove('active');
            });

            // Open the requested sheet
            document.getElementById(id).classList.add("active");

            // Show backdrop
            const backdrop = document.getElementById('sheetBackdrop');
            if (backdrop) {
                backdrop.classList.add('active');
            }
        }

        function closeSheet(id) {
            // Reset product state when closing options sheet
            if (id === 'optionsSheet') {
                resetProductState();
            }

            // Auto-clear canceled orders when closing tracker sheet
            if (id === 'trackerSheet') {
                // Remove any orders that are "Annul√©" or "Storniert" or "Canceled"
                // This ensures the red notification disappears only AFTER the user has seen it and closed the sheet.
                activeOrders = activeOrders.filter(o =>
                    o.status !== "Annul√©" &&
                    o.status !== "Storniert" &&
                    o.status !== "Canceled"
                );
                updateDynamicIsland(); // Refresh the pill immediately
            }

            document.getElementById(id).classList.remove("active");

            // Check if any sheets are still open
            const anySheetOpen = Array.from(document.querySelectorAll('.bottom-sheet')).some(
                sheet => sheet.classList.contains('active')
            );

            // Hide backdrop if no sheets are open
            if (!anySheetOpen) {
                const backdrop = document.getElementById('sheetBackdrop');
                if (backdrop) {
                    backdrop.classList.remove('active');
                }
            }
        }

        function closeAllSheets() {
            // Close all bottom sheets
            document.querySelectorAll('.bottom-sheet').forEach(sheet => {
                sheet.classList.remove('active');
            });

            // Hide backdrop
            const backdrop = document.getElementById('sheetBackdrop');
            if (backdrop) {
                backdrop.classList.remove('active');
            }
        }

        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.classList.add("show");

            setTimeout(() => {
                toast.classList.remove("show");
            }, 3000);
        }

        // Make functions globally available
        window.openProduct = openProduct;
        window.openCart = openCart;
        window.openTracker = () => {
            renderTracker();
            openSheet("trackerSheet");
        };
        window.setTable = setTable;
        window.filterMenu = filterMenu;
        window.addToCart = addToCart;
        window.sendBatchOrder = sendBatchOrder;
        window.callWaiter = callWaiter;
        window.cancelOrder = cancelOrder;
        window.cancelOrderItem = cancelOrderItem;
        window.removeFromCart = removeFromCart;
        window.closeSheet = closeSheet;

        // Add cart icon to dynamic island when clicked
        document.getElementById('dynamicIsland').addEventListener('click', () => {
            if (activeOrders.length > 0) {
                // Remove critical class on click (acknowledgment)
                const island = document.getElementById('dynamicIsland');
                if (island) {
                    island.classList.remove('critical');
                }
                openTracker();
            }
        });
    </script>
</body>

</html>